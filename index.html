<!doctype html>

<html>  
  <head>
    <meta charset='utf-8' />
    <title>mado | Markdown Editor</title>

    <!-- ace -->
    <script src='http://cdn.jsdelivr.net/ace/1.2.0/min/ace.js'></script>
    <script src='http://cdn.jsdelivr.net/ace/1.2.0/min/ext-language_tools.js'></script>
    <script src='http://cdn.jsdelivr.net/ace/1.2.0/min/ext-emmet.js'></script>

    <!-- marked -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.5/marked.js'></script>
    <!-- jframe -->
    <script src='http://cdn.rawgit.com/phi-jp/jframe/0.0.2/jframe.js'></script>
  </head>
  <body>
    <div id='editor'></div>
    <div id='preview'></div>
  </body>
</html>

<style>
#editor, #preview {
  position: absolute;
  width: 50vw;
  height: 100vh;
  top: 0px;
}
#editor {
  left: 0px;
}
#preview {
  right: 0px;
}

#preview iframe {
  width: 100%;
  height: 100%;
  border: none;
}
</style>

<script>
var fs      = require('fs');
var remote  = require('remote');
var Menu = remote.require('menu');
var Dialog  = remote.require('dialog');

var file = {
};

var open = function(filename) {
  if (filename) {
    fs.readFile(filename, 'utf8', function(error, data) {
      if (error) { throw error; }
      file.filename = filename;
      sync(data);

      localStorage.setItem('history', file.filename);
      console.log('opened', filename);
    });
  }
};
var openFileDialog = function() {
  Dialog.showOpenDialog(function(filenames) {
    if (!filenames) return ;
    open(filenames[0]);
  });
};
var saveFileDialog = function() {
  var save = function(filename) {
    fs.writeFile(filename, editor.getValue(), function(error, data) {
      if (error) { throw error; }
      console.log('saved', filename);
    });
  };

  if (file.filename) {
    save(file.filename);
  }
  else {
    Dialog.showSaveDialog(function(filename) {
      if (filename) {
        save(filename);
        file.filename = filename;
      }
    });
  }
};

var template = [
  {
    label: 'Markdown Editor',
  },
  {
    label: 'File',
    submenu: [
      {
        label: 'Open',
        click: openFileDialog,
      },
      {
        label: 'Save',
        accelerator: "CmdOrCtrl+S",
        click: saveFileDialog,
      },
    ],
  },
  {
    label: 'Edit',
    submenu: [
      { label: "Copy", accelerator: "CmdOrCtrl+C", selector: "copy:" },
      { label: "Paste", accelerator: "CmdOrCtrl+V", selector: "paste:" },
    ],
  },
];

var menu = Menu.buildFromTemplate(template);
Menu.setApplicationMenu(menu);

</script>

<script>

var styleFile = 'http://cdn.rawgit.com/jasonm23/markdown-css-themes/gh-pages/markdown7.css';
var pluginsCode = '<link rel="stylesheet" href="' + styleFile + '" />' + '';
var editor = null;
var preview = null;

window.onload = function() {
  // editor
  editor = ace.edit('editor');
  editor.$blockScrolling = Infinity;
  editor.setTheme("ace/theme/monokai");
  editor.getSession().setMode("ace/mode/markdown");
  editor.setFontSize(13);
  editor.setValue('# title');
  editor.getSession().setTabSize(2);

  // preview
  preview = jframe("#preview");
  preview.load(pluginsCode);
  
  editor.on('change', convert);
  convert();

  // open from history
  var filename = localStorage.getItem('history');
  open(filename);
};

// convert
var convert = function() {
  var v = editor.getValue();
  var code = marked(v);
  preview.getDocument().body.innerHTML = code;
};

var sync = function(v) {
  editor.setValue(v);
  convert();
};

</script>
